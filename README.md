# SmallChat (Day7)

一个基于 TCP 的终端聊天室，支持昵称登记、多人群聊、`/quit` 退出。项目以最小可运行结构展示了 `select` 驱动的单线程网络服务器。

## 架构模式
- **事件驱动/反应器 (Reactor) + 单线程 I/O 多路复用**  
  服务端使用 `select` 统一监听监听套接字与所有客户端套接字，按可读事件分发处理。
- **分层结构**  
  `main -> Server -> Connection`。`Server` 负责连接管理、协议状态与广播逻辑，`Connection` 负责单连接读写细节。

## 设计模式（轻量使用）
- **Reactor 模式**：`select` 作为事件源，循环中对就绪 fd 进行处理。
- **Facade/封装**：`Connection` 封装 socket 操作，简化 `Server` 的业务逻辑。

## 功能
- 多客户端同时连接
- 昵称登记（首次输入为昵称）
- 群聊广播（只发给其他客户端）
- `/quit` 退出并通知其他人
- 服务端打印连接与消息日志

## 协议与交互
- **昵称阶段**：客户端连接后第一次发送的内容视为昵称，服务端仅记录，不广播。
- **消息阶段**：后续每一条消息都会被广播给其他客户端，格式为：  
  `[nickname]: message\n`
- **退出**：客户端发送 `/quit` 后服务端广播：  
  `[system]: <nickname> left\n` 并断开连接。

## 编译
```bash
g++ -std=c++17 -Wall -Wextra -pedantic main.cpp server.cpp connection.cpp -o server
g++ -std=c++17 -Wall -Wextra -pedantic client.cpp -o client
```

## 运行
启动服务端：
```bash
./server
```

另开多个终端启动客户端：
```bash
./client
```

## 使用说明
1. 客户端启动后先输入昵称并回车。
2. 随后输入消息即可聊天。
3. 输入 `/quit` 退出聊天室。

## 代码结构
- `main.cpp`：程序入口，创建 `Server` 并启动事件循环。
- `server.h/.cpp`：监听、`select` 循环、连接状态与广播逻辑。
- `connection.h/.cpp`：单连接读写封装。
- `client.cpp`：终端客户端，使用 `select` 监听键盘输入与服务器消息。

## 关键实现点
- `select` 事件循环只在可读事件发生时处理 socket，避免忙等。
- 服务器维护连接状态（是否已登记昵称）。
- 广播时只发送给其他客户端，避免客户端自回显。

## 适用范围与限制
- 仅支持本地或同一局域网内测试，未做鉴权与加密。
- 消息为行文本，未处理粘包/拆包边界。
- 未实现心跳、断线重连、历史消息等高级功能。

## 常见问题
- **端口被占用**：更换 `main.cpp` 中的端口或释放占用进程。
- **没有消息显示**：确认昵称已发送，且至少有另一个客户端在线。

## 可扩展方向
- 增加消息历史与离线消息缓存
- 支持私聊、群组、在线列表
- 增加心跳与超时清理
- 使用 `epoll` 替换 `select` 以支持更多连接
